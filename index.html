<!DOCTYPE html>
<html>
    <head>
        <title>Home</title>

        <script src="reunion.js"></script>

        <script src="xml.js"></script>

        <script src="fakeResponses.js"></script>
        <script src="anw.js"></script>

        <script src="gtb.js"></script>

        <script src="dummy.js"></script>
        <style>
body {
    font-size: 120%;
}

a.icon {
    text-decoration: none;
}

#results {
    max-width: 20cm;
    margin: 0 auto;
}

#results h2 {
    font-family: sans-serif;
    font-weight: bold;
    font-size: 1.2em;
    padding: 0.6rem 0.6rem 0.4rem 0.6rem;
    margin: 0;
    background-color: rgb(241, 241, 241);
}

.results > li > p > a {
    font-weight: bold;
}

.results > li > p > em {
    font-style: italic;
    color: #07606e;
    font-weight: bold;
}

.results .betnr {
    font-weight: bold;
}

        </style>
    </head>
    <body>
        <h1>Unified search ][ - The API strikes back!</h1>
        <p>
            <form id="form">
                <input id="search" type="text" name="search" placeholder="Search...">
                <input type="submit" value="Search">
            </form>
        </p>
        <div id="results">
        </div>
        <script>

            // Set up our results areas based on the resources we're querying
            document.getElementById('results').innerHTML = REUNION.resources
                .map(resource => 
                    `<h2>${resource.title}
                        <span id='num-${resource.id}'></span>
                    </h2>
                    <ul class="results" id="results-${resource.id}">
                    </ul>`)
                .join('');

            // Hook into Reunion(TM)
            document.getElementById('form').addEventListener('submit', (e) => {
                e.preventDefault();
                const searchString = document.getElementById('search').value;
                REUNION.performSearch(searchString, {
                    searchStarted(service) {
                        //console.log(`Started search on ${service.id} (resources ${service.resources.map(r => r.id)}) for ${searchString}`);
                        service.resources.forEach(resource => {
                            document.getElementById(`results-${resource.id}`).innerHTML = '<p>Searching...</p>';
                        });
                    },

                    searchCompleted(resource, results) {
                        document.getElementById(`num-${resource.id}`).innerText = `[${results.length}]`;
                        document.getElementById(`results-${resource.id}`).innerHTML = results.map(result => {
                            const hist = result.historischLemma && result.historischLemma.toLowerCase() !== result.modernLemma.toLowerCase() ? 
                                ` ("${result.historischLemma.toLowerCase()}")` : '';
                            const bet2html = bet => {
                                if (bet.markdown)  {
                                    return `<li>${markdownToHtml(bet.markdown)}</li>`;
                                } else {
                                    return`<li>
                                        <span class='betnr'>${bet.nr}</span>
                                        ${bet.definitie}
                                        <a class='icon' href="${bet.url}" target="_blank">âž¤</a>
                                    </li>`;
                                }
                            };
                            const betHtml = result.betekenissen.map(bet2html).join('');
                            const artHtml = result.markdown ? `${markdownToHtml(result.markdown)}` : 
                                `<a href="${result.url}" target="_blank">${result.modernLemma}</a>${hist}
                                <span class='woordsoort'>${result.woordsoort}</span>`;
                            return `
                                <li>
                                    <p>${artHtml}</p>
                                    <ul class="bet">${betHtml}</ul>
                                </li>`;
                        }).join('');
                    },

                    searchFailed(service, reason) {
                        console.log(`FAILED: search on ${service.id} (resources ${service.resources.map(r => r.id)}) for ${searchString}, reason: ${reason}`);
                        service.resources.forEach(resource => {
                            document.getElementById(`results-${resource.id}`).innerHTML = `<p>Search on ${resource.id} failed: ${reason}</p>`;
                        });
                    }
                });
            });
        </script>
    </body>
</html>
